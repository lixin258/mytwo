
<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/LCalendar.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
</head>
<style media="screen">
    .aui-icon-right {
        font-size: 0.4rem;
        font-weight: bold;
        color: #787878;
    }

    .fr {
        float: right;
    }

    .avatar {
        margin: 0.5rem 0;
        line-height: 3rem;
        position: relative;
    }

    .avatar img {
        display: inline-block;
        height: 3rem;
        width:3rem;
        position: absolute;
        top: 0rem;
        padding:0;
        right: 1.5rem;
        border-radius: 0.5rem;
    }

    .item {
        padding: 0 0.5rem 0 0.8rem;
        line-height: 1.5rem;
    }

    .title {
        color: #3A2A11;
        font-size: 0.7rem;
    }

    .info {
        padding-right: 0.4rem;
        font-size: 0.7rem;
        color: #787878;
    }

    .moneyRecord .aui-list.aui-list-in .aui-list-item {
        background-position: 2.25rem bottom;
    }

    .moneyRecord .aui-list .aui-list-item-label-icon {
        padding-right: 0.5rem;
    }

    .moneyRecord .aui-list .aui-list-item-inner {
        min-height: 2.5rem;
    }

    .moneyRecord img {
        position: relative;
        display: inline-block;
        width: 1rem;
        height: 1rem;
        max-width: 1rem;
    }
    .mt-40{
        margin-top: 2rem;
    }
    .userInfo .aui-list.aui-list-in .aui-list-item {
        background-position: 0.75rem bottom !important;
    }
    .z-bg{
      background:#0098ff;
      color:white;
    }
    .itemBox2{
      padding:0.75rem;
      background:white;
    }
    .itemBox2 ul{
      padding:1rem 0;
    }
    .itemBox2 li {
        display: inline-block;
        background: #f0f0f0;
        padding: 0rem 0.5rem;
        color: #777;
        border-radius: 1rem;
        min-width: 4rem;
        text-align: center;
        position: relative;
    }

    .itemBox2 li i {
        position: absolute;
        right: -0.25rem;
        top: -0.25rem;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        font-size: 0.5rem;
        background: #1890eb;
        color: #fff;
        line-height: 0.8rem;
        overflow: hidden;
    }
    .itemBox2 .addType{
      border:1px dashed #1890eb;
      color:#1890eb;
      background:white;
    }
    .itemBox2 ul{
      padding:0;
    }
    .itemBox2 ul li{
      margin-right:0.5rem;
      margin-bottom:0.5rem;
    }
    .Explain{
      padding: 0.75rem;
      padding-top: 0;
      background: #fff;
    }
    .Explain textarea{
      border: 1px solid #eee;
      padding: 0.5rem;
      font-size: 16px;
      line-height: 1rem;
      height: 3rem;
      margin-top: 0.75rem;
    }
</style>
<body class="bodyBc">
    <div class="aui-content aui-margin-b-15 userInfo" id="app">
        <ul class="aui-list aui-list-in z-no-bt">
            <li class="aui-list-item" id="uploadPhoto">
                <div class="aui-list-item-inner z-inner avatar">
                    头像
                    <img id="avatar" class="z-photo logo" src="../../image/logo.png" alt="">
                </div>
            </li>
        </ul>
        <ul class="aui-list aui-list-in aui-margin-t-10 z-no-bt">
            <li class="aui-list-item">
                <div class="aui-list-item-inner z-inner">
                    手机号
                    <span id='phone' class="aui-pull-right"></span>
                </div>
            </li>
            <li class="aui-list-item"  id="editName">
                <div class="aui-list-item-inner aui-list-item-arrow z-inner">
                    姓名
                    <span id='nickname' class="aui-pull-right"></span>
                </div>
            </li>
            <li class="aui-list-item" style="position: relative;">
                <div class="aui-list-item-inner aui-list-item-arrow z-inner">
                    生日
                    <input id="birthday" class="aui-pull-right" type="text" readonly="" name="input_date" placeholder="" data-lcalendar="2018-01-01,2028-12-31" style="text-align:right;position:absolute;right:1.5rem;top:0;height:100%;"/>
                </div>
            </li>
            <li class="aui-list-item" id="genderChoose">
                <div class="aui-list-item-inner aui-list-item-arrow z-inner">
                    性别
                    <span id='gender' class="aui-pull-right"></span>
                </div>
            </li>
            <li class="aui-list-item" id="addSelect">
                <div class="aui-list-item-inner aui-list-item-arrow z-inner">
                    常驻城市
                    <span id="address" class="aui-pull-right"></span>
                </div>
            </li>
        </ul>
        <ul class="aui-list aui-list-in aui-margin-t-10 z-no-bt">
            <li class="aui-list-item workyear" id="workyearChoose">
                <div class="aui-list-item-inner z-inner">
                    工作年限
                    <span id='workyear' class="aui-pull-right">
                    </span>
                </div>
            </li>
            <li class="aui-list-item" id="carSelect">
                <div class="aui-list-item-inner aui-list-item-arrow z-inner">
                    擅长车型
                    <span id='carInfo' class="aui-pull-right"></span>
                </div>
            </li>
            <li class="aui-list-item" style="position: relative;">
                <div class="aui-list-item-inner z-inner">
                    可提供服务
                  </div>
            </li>
        </ul>
        <div class='itemBox2'>
            <ul class='serviceList'>
               <li class="addType">添加</li>
            </ul>
            <ul class="serviceItem aui-hide" ></ul>
        </div>
        <div class="Explain">
            <div>服务说明：</div>
            <textarea name="" id="explainCon" placeholder="最多十个字符"></textarea>
        </div>
        <div v-if="userInfo.status != 1" class="aui-padded-r-10 aui-padded-l-10 mt-40">
            <div class="aui-btn aui-btn-block z-bg" id='submit'>提交认证</div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery.js"></script>
<script type="text/javascript" src="../../script/fastclick.js"></script>
<script type="text/javascript" src="../../script/LCalendar.js"></script>
<script type="text/javascript" src="../../script/tool.js"></script>
<script type="text/javascript" src="../../config.js"></script>
<script src="../../script/LCalendar.js"></script>
<script type="text/javascript">

    apiready = function() {
        var Home = function(){
          this.pageArr = [
                          { title: "昵称", key: "nickname", type: "text"},
                          { title: "擅长车型", key: "carInfo", type: "text"},
                      ];
          this.gender =0 ;
          this.workyear=0;
          this.provinceId = '';
          this.cityId = '';
          this.regionId = '';
          this.nickname='';
          this.carInfo='';
          this.init();
        }
        Home.prototype={
          init:function(){
            this.listenEvent();
            this.getData();
            this.bindClick();
            this.initCalendar();
            FastClick.attach(document.body);
          },
          listenEvent: function(){
            var self=this;
              api.addEventListener({
                  name: 'userInfoEdit'
              }, function(ret, err){
                  if( ret ){
                      // vm.userInfo[ret.value.key] = ret.value.value;
                      // vm.infochange = true;
                      $('#'+ret.value.key+'').html(ret.value.value);
                      self.nickname=ret.value.value;
                  }
              });
              api.addEventListener({
                  name: 'userInfoEdit1'
              }, function(ret, err){
                  if( ret ){
                      // vm.userInfo[ret.value.key] = ret.value.value;
                      // vm.infochange = true;
                      $('#'+ret.value.key+'').html(ret.value.value);
                      self.carInfo=ret.value.value;
                  }
              });
              api.addEventListener({
                  name: 'chooseServiceType1'
              }, function(ret, err){
                if (ret) {
                  var flag=true;
                  $.each($('.serviceList li'),function(){
                    if(ret.value.serviceName==$(this).text()){
                      Tool.toastInfo("已添加");
                      flag=false;
                      return;
                    }
                  })
                  if(flag){
                    $('.serviceList').prepend('<li data-typeid=' + ret.value.serviceId + '>' + ret.value.serviceName + '<i class="aui-iconfont aui-icon-close"></i></li>');
                    $('.serviceItem').prepend('<li data-typeid=' + ret.value.infoId + '>' + ret.value.infoName + '<i class="aui-iconfont aui-icon-close"></i></li>');
                  }
                  api.sendEvent({
                      name: 'chooseClick'
                  });
                }

              });
              api.addEventListener({
                  name: 'chooseClick'
              }, function() {
                  $('.itemBox2 li i').off('click').on('click', function() {
                      $(this).parent().remove();
                  });
              })
          },
          getData: function(){
              var self = this;
              $('#phone').text($api.getStorage('phone'));
              api.ajax({
                  url: SERVER_PATH + 'Agency/getInfo',
                  method: 'post',
                  data: {
                      values: {
                          AccessToken: $api.getStorage('token'),
                          userId: $api.getStorage('userId')
                      },
                      files: {}
                  }
              }, function(ret, err) {
                self.provinceId = ret.data.provinceId;
                self.cityId = ret.data.cityId;
                self.regionId = ret.data.regionId;
                self.introduce=ret.data.introduce;
                  if (ret && ret.code == 0) {
                      if(ret.data){
                          var data = ret.data[0];
                          $('#phone').html($api.getStorage('phone'));
                          $('#nickname').html(data.realname || '');
                          $('#avatar').attr('src',data.headimgurl || '../../image/logo.png');
                          $('#workyear').html(data.workyear);
                          $('#gender').html(data.gender);
                          $('#birthday').val(data.birthday);
                          $('#carInfo').html (data.carInfo);
                          $('#address').html(data.provinceName +' '+ data.cityName +' '+ data.regionName);
                          $('#explainCon').val(data.introduce);
                          self.nickname=data.realname;
                          self.carInfo=data.carInfo;
                          if(data.gender=='女'){
                            self.gender=0
                          }else {
                            self.gender=1
                          }
                          {
                            var provinceName = data.provinceName || '';
                            var cityName = data.cityName || '';
                            var regionName = data.regionName || '';
                            // $('#address').html(`${provinceName} ${cityName} ${regionName}`);
                            $('#address').html(provinceName + ' ' + cityName + ' ' + regionName);
                          }
                          self.provinceId = data.provinceId;
                          self.cityId = data.cityId;
                          self.regionId = data.regionId;
                      }

                  } else {
                      Tool.toastInfo(errMsg);
                  }
              });
              api.ajax({
                url: SERVER_PATH + 'Agency/getOwnSerInfo',
                method: 'post',
                data: {
                  values: {
                    AccessToken: $api.getStorage('token'),
                    id: $api.getStorage('userId')
                  },
                  files: {}
                }
              }, function (ret, err) {
                if (ret) {
                  var html = '';
                  var html1 = '';
                  console.log(ret.data)
                  if (!ret.data) return;
                  var data = ret.data;
                  $(".serviceList").empty("");
                  $(".serviceItem").empty("");
                  for (var i = 0; i < data.length; i++) {
                    // html += `<li data-typeid = ${data[i].id}>${data[i].name}</li>`;
                    if(data[i].name!=null){
                      html += '<li data-typeid="' + data[i].firstId  + '">' + data[i].name + '<i class="aui-iconfont aui-icon-close"></i></li>';
                      html1 += '<li data-typeid="' + data[i].secondId + '">' + data[i].name + '<i class="aui-iconfont aui-icon-close"></i></li>';
                    }
                  }
                  html += '<li class="addType">添加</li>';
                  $(".serviceList").html(html);
                  $(".serviceItem").html(html1);
                  self.bindClick();
                  api.sendEvent({
                      name: 'chooseClick'
                  });
                } else {
                  Tool.toastInfo(errMsg);
                }
              });
          },
          bindClick: function(){
              var self = this;
              $('#submit').off('click').on('click', function(){
                  self.confirm();
              });
              $('#addSelect').off('click').on('click',function(){
                self.chooseCity();
              });
              $('#editName').off('click').on('click',function(){
                self.openPage(0);
              });
              $('#carSelect').off('click').on('click',function(){
                self.openPage1(1);
              });
              $('#genderChoose').off('click').on('click',function(){
                self.genderChoose();
              });
              $('#workyearChoose').off('click').on('click',function(){
                self.workyearChoose();
              });
              // $('.workyear').off('click').on('click',function(){
              //   self.openPage(1);
              // });
              $('.addType').off('click').on('click',function(){
                Tool.openHeader({
                    name: 'chooseService',
                    frame: {
                        title: '选择可提供服务',
                        url: api.wgtRootDir + '/html/chooseService.html',
                        param: {
                            newService: '1'
                        }
                    }
                });
              });
              $('#uploadPhoto').off('click').on('click', function(){
                  api.actionSheet({
                      title: '上传方式',
                      cancelTitle: '取消',
                      buttons: ['拍照上传', '从相册选择']
                  }, function (ret, err) {
                      if (ret.buttonIndex == 3) return;
                      var index = ret.buttonIndex;
                      switch (index) {
                          case 1: type = 'camera'; break;
                          case 2: type = 'album'; break;
                      }
                      Tool.getPicture(type, 'getPictureAtUser');//选择图片
                  });
                  api.addEventListener({
                      name: 'getPictureAtUser'
                  }, function (ret, err) {
                      var json = ret.value;
                      if (json.ret && json.ret.data) {
                          Tool.uploadImage(UploadImageApi, json.ret.data, 'uploadImageAtUser'); //上传图片
                          api.addEventListener({
                              name: 'uploadImageAtUser'
                          }, function (ret, err) {
                              var json2 = ret.value;
                              if (json2.ret.code == 0) {
                                $('#avatar').attr('src',json2.ret.CDNPath)
                                  //self.updatePhoto(json2.ret.CDNPath);
                              }
                          });
                      }
                  });
              });
          },
          updatePhoto: function (url) {
              var self = this;
              var id = $api.getStorage('userId');
              var headimgurl = url;
              api.ajax({
                  url: SERVER_PATH + 'User/updateUser',
                  method: 'post',
                  data: {
                      values: self.userInfo,
                      files: {}
                  }
              }, function (ret, err) {
                  if (ret && ret.code == 0) {
                      $('#uploadPhoto img').attr('src', url);
                      Tool.toastInfo('头像上传成功');
                  } else {
                      Tool.toastInfo(errMsg);
                  }
              });
          },
          openPage: function(index) {
              var self = this;
              //if(this.userInfo.status == 1) return;
              Tool.openHeader({
                  frame: {
                      title: self.pageArr[index].title,
                      url: api.wgtRootDir + '/html/input.html',
                      param: {
                          title: self.pageArr[index].title,
                          type: self.pageArr[index].type,
                          key: self.pageArr[index].key,
                          value:self.nickname
                          //value: self.userInfo[self.pageArr[index].key]
                      }
                  }
              });
          },
          openPage1: function(index) {
              var self = this;
              console.log(self.carInfo)
              //if(this.userInfo.status == 1) return;
              Tool.openHeader({
                  frame: {
                      title: self.pageArr[index].title,
                      url: api.wgtRootDir + '/html/input.html',
                      param: {
                          title: self.pageArr[index].title,
                          type: self.pageArr[index].type,
                          key: self.pageArr[index].key,
                          value:self.carInfo
                          //value: self.userInfo[self.pageArr[index].key]
                      }
                  }
              });
          },
          confirm: function(){
            var self = this;
            var strL = $("#explainCon").val().length;
            if(strL>10){
              Tool.toastInfo("服务说明字数过多")
            }else{
              Tool.confirm('确认提交?', 'updateInfo');
              api.addEventListener({
                  name: 'updateInfo'
              }, function(ret, err){
                  self.updateUserInfo();
              });
            }
          },
          genderChoose: function(){
            var self = this;
              api.actionSheet({
                  title: '选择',
                  cancelTitle: '取消',
                  buttons: ['女', '男']
              }, function(ret, err) {
                  var index = ret.buttonIndex;
                  if(index == 1){
                    $('#gender').html('女');
                      self.gender = 0;
                      // vm.userInfo.genderText = '女';
                  }
                  if(index == 2){
                    $('#gender').html('男')
                      self.gender = 1;
                      // vm.userInfo.genderText = '男';
                  }
              });
          },
          workyearChoose: function(){
            var self = this;
              api.actionSheet({
                  title: '选择',
                  cancelTitle: '取消',
                  buttons: ['一年以下', '1-3年','4-5年','5年以上','10年以上']
              }, function(ret, err) {
                  var index = ret.buttonIndex;
                  if(index == 1){
                    $('#workyear').html('一年以下');
                      self.workyear = '一年以下';
                      // vm.userInfo.genderText = '女';
                  }
                  if(index == 2){
                    $('#workyear').html('1-3年')
                      self.workyear = '1-3年';
                      // vm.userInfo.genderText = '男';
                  }
                  if(index == 3){
                    $('#workyear').html('4-5年')
                      self.workyear ='4-5年';
                      // vm.userInfo.genderText = '男';
                  }
                  if(index == 4){
                    $('#workyear').html('5年以上')
                      self.workyear = '5年以上';
                      // vm.userInfo.genderText = '男';
                  }
                  if(index == 5){
                    $('#workyear').html('10年以上')
                      self.workyear = '10年以上';
                      // vm.userInfo.genderText = '男';
                  }
              });
          },
          chooseCity: function(){
              var self=this;
              var UIActionSelector = api.require('UIActionSelector');
              UIActionSelector.open({
                  datas: api.wgtRootDir + '/res/gp.json',
                  layout: {
                      row: 5,
                      col: 3,
                      height: 30,
                      size: 12,
                      sizeActive: 14,
                      rowSpacing: 5,
                      colSpacing: 10,
                      maskBg: 'rgba(0,0,0,0.2)',
                      bg: '#fff',
                      color: '#888',
                      colorActive: 'rgb(58, 118, 241)',
                      colorSelected: 'rgb(58, 118, 241)'
                  },
                  animation: true,
                  cancel: {
                      text: '取消',
                      size: 12,
                      w: 90,
                      h: 35,
                      bg: '#fff',
                      bgActive: '#ccc',
                      color: '#888',
                      colorActive: '#fff'
                  },
                  ok: {
                      text: '确定',
                      size: 12,
                      w: 90,
                      h: 35,
                      bg: '#fff',
                      bgActive: '#ccc',
                      color: '#888',
                      colorActive: '#fff'
                  },
                  title: {
                      text: '请选择所属区域',
                      size: 12,
                      h: 44,
                      bg: '#eee',
                      color: '#888'
                  },
              }, function(ret, err) {
                  if (ret) {
                      if(ret.eventType=="cancel")return;
                      sInfo = ret.selectedInfo;
                      self.provinceId = sInfo[0].id;
                      self.cityId = sInfo[1].id;
                      self.regionId = sInfo[2].id;
                      $('#address').text(sInfo[0].name+' '+ sInfo[1].name+' '+sInfo[2].name);
                  } else {
                      Tool.toastInfo(errMsg);
                  }
              });
          },
          updateUserInfo: function(){
            var ids = $(".serviceList>li");
            var idss = $(".serviceItem>li");
            var arr=new Array();
            var arr1=new Array();
            for (var i = 0; i < ids.length - 1; i++) {
              arr.push(ids[i].dataset.typeid);

            }
            var str=arr.join(",");
            for (var i = 0; i < idss.length; i++) {
              arr1.push(idss[i].dataset.typeid);
            }
            var str1=arr1.join(",");
              var self = this;
              var data = this.userInfo;
              api.showProgress();
              api.ajax({
                  url: SERVER_PATH + 'Agency/updateTechnician',
                  method: 'post',
                  data: {
                      values: {
                          userId: $api.getStorage('userId'),
                          realname:$('#nickname').html(),
                          gender:self.gender,
                          workyear:$('#workyear').html(),
                          birthday:$('#birthday').val(),
                          carInfo:$('#carInfo').html(),
                          headimgurl:$('#avatar').attr("src"),
                          provinceId:self.provinceId,
                          cityId:self.cityId,
                          regionId:self.regionId,
                          introduce:$('#explainCon').val()
                      },
                      files: {}
                  }
              }, function(ret, err) {

                  api.hideProgress();
                  if (ret && ret.code == 0) {
                      Tool.toastInfo(ret.msg || okMsg);
                      setTimeout(function(){
                          api.closeWin();
                      }, 1500);
                  } else {
                      Tool.toastInfo('设置失败或您没有修改任何信息');
                  }
              });
              api.ajax({
                url: SERVER_PATH + 'Agency/addService',
                method: 'post',
                data: {
                  values: {
                    userId: $api.getStorage('userId'),
                    serviceId: str,
                    infoId: str1
                  },
                  files: {}
                }
              }, function (ret, err) {
                api.hideProgress();
                if (ret && ret.code == 0) {
                  Tool.toastInfo(ret.msg || okMsg);
                  setTimeout(function () {
                    api.closeWin();
                  }, 1500);
                } else {
                  Tool.toastInfo('设置失败或您没有修改任何信息');
                }
              });
          },
          uploadImage: function(index){
              if(this.userInfo.status == 1) return;
              api.actionSheet({
                  title: '上传方式',
                  cancelTitle: '取消',
                  buttons: ['拍照上传', '从相册选择']
              }, function(ret, err) {
                  if(ret.buttonIndex == 3) return;
                  var index = ret.buttonIndex, type;
                  switch(index){
                      case 1: type = 'camera';break;
                      case 2: type = 'album';break;
                  }
                  Tool.getPicture(type, 'getPictureAtUserInfo');//选择图片
              });

              api.addEventListener({
        name : 'getPictureAtUserInfo'
      }, function(ret, err) {
      var json = ret.value;
      if(json.ret && json.ret.data){
                    Tool.uploadImage(UploadImageApi, json.ret.data, 'uploadImageAtUserInfo'); //上传图片
        api.addEventListener({
            name : 'uploadImageAtUserInfo'
          }, function(ret, err) {
          var json2 = ret.value;
          if(json2.ret.code == 0){
                              var src = json2.ret.thumbPath;
            if(index == 1) vm.userInfo.idCardOnURL = src;
            if(index == 0) vm.userInfo.idCardOffURL = src;
                              vm.infochange = true;
          }else{
            Tool.toastInfo(errMsg);
          }
          });
                }
      });
          },
      initCalendar: function () {
        var calendar = new LCalendar();
        calendar.init({
              'trigger': '#birthday',
              'type': 'date',
              'minDate': '1900-01-01',
              'maxDate': new Date().getFullYear() + '-' + (new Date().getMonth() + 1) + '-' + new Date().getDate()
          });
      },
    }
    new Home();
  }
</script>

</html>
